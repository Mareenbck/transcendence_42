// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["aggregateApi"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
	id				          Int			    @id @default(autoincrement())
	id42			          Int			    @default(autoincrement())
	createdAt		        DateTime    @default(now())

	email			          String		  @unique
	hash			          String
	username		        String		  @unique
	status			        UserStatus	@default(OFFLINE)
	avatar			        String?
	ftAvatar		        String?

	hashedRtoken	      String?
	twoFAsecret		      String?
	twoFA			          Boolean?	@default(true)

  blockedTo           User[]       @relation("Blocked")
  blockedFrom         User[]       @relation("Blocked")

  friends             User[]        @relation("Friends")
  friendOf            User[]        @relation("Friends")
  sentFriendships     Friendship[]  @relation("SentFriendships")
  receivedFriendships Friendship[]  @relation("ReceivedFriendships")

  playerOne     Game[]  @relation("GamePlayerOne")
  playerTwo     Game[]  @relation("GamePlayerTwo")
  winner        Game[]  @relation("GameWinner")

  chatrooms  ChatroomUsers[]
  dirMessEmited   DirectMessage[] @relation(name: "emited")
  dirMessReceived DirectMessage[] @relation(name: "received")
  crMessSent      ChatroomMessage[]

  userOnChanel UserOnChannel[] 
	@@map("users")
}

model Friendship {
  id            Int               @id @default(autoincrement())
  status        FriendshipStatus  @default(PENDING)
  requester     User              @relation("SentFriendships", fields: [requesterId], references: [id])
  requesterId   Int
  receiver      User              @relation("ReceivedFriendships", fields: [receiverId], references: [id])
  receiverId    Int
  @@unique([requesterId, receiverId])
}

model Game {
	id			        Int			@id @default(autoincrement())
	createdAt	      DateTime	@default(now())
	playerOne				User	@relation("GamePlayerOne", fields: [playerOneId], references: [id])
	playerOneId		  Int
	playerTwo				User	@relation("GamePlayerTwo", fields: [playerTwoId], references: [id])
	playerTwoId		  Int
  winner          User    @relation("GameWinner", fields: [winnerId], references: [id])
  winnerId      Int
  score1        Int
  score2        Int
	@@map("games")
}

enum UserStatus {
	ONLINE
	OFFLINE
	PLAYING
}

model UserOnChannel {
  id        Int              @id @default(autoincrement())
  role      UserRoleInChannel @default(USER)
  status    UserStatusOnChannel @default(CLEAN)
  user      User             @relation(fields: [userId], references: [id])
  channelId Int
  channel   Chatroom         @relation(fields: [channelId], references: [id])
  userId    Int

  @@unique([channelId, userId])
}

model Chatroom {
  id           Int              @id @default(autoincrement())
  visibility   UserChannelVisibility   @default(PUBLIC)
  name         String
  users        ChatroomUsers[]
  participants UserOnChannel[]   
  cr_messages  ChatroomMessage[]
  hash         String?
}


enum UserChannelVisibility {
    PUBLIC
    PRIVATE
    PWD_PROTECTED
}

enum UserRoleInChannel {
  USER 
  ADMIN
}

enum UserStatusOnChannel {
  CLEAN
  MUTE
  BAN
}

model ChatroomUsers {
  createdAt DateTime  @default(now())
  id          Int     @id @default(autoincrement())
  userId      Int
  user        User    @relation(fields: [userId], references: [id])
  chatroomId  Int
  chatroom    Chatroom @relation(fields: [chatroomId], references: [id])
  @@unique([userId, chatroomId])
}

model ChatroomMessage {
  id      Int     @id @default(autoincrement())
  content  String
  chatroomId Int
  chatroom Chatroom @relation(fields: [chatroomId], references: [id])
  authorId  Int
  author    User    @relation(fields: [authorId], references: [id])
  createdAt DateTime  @default(now())
}

model DirectMessage {
  id      Int     @id @default(autoincrement())
  content String
  author    Int
  userA        User    @relation(name: "emited", fields: [author], references: [id])
  receiver  Int
  userR        User    @relation(name: "received", fields: [receiver], references: [id])
  createdAt DateTime  @default(now())
}

enum FriendshipStatus {
	ACCEPTED
	PENDING
	REFUSED
}
